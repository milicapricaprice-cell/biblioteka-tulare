        image: { content: base64 },
        features: [{ type: "TEXT_DETECTION" }]
      }]
    };

    try {
      const res = await fetch(`https://vision-proxy.fly.dev/?key=${OCR_API_KEY}`, {
        method: "POST",
        body: JSON.stringify(body)
      });
      const data = await res.json();
      const text = data.responses?.[0]?.fullTextAnnotation?.text || "";
      if (!text.trim()) {
        statusEl.textContent = "⚠️ Nije pronađen tekst na slici.";
        return;
      }

      statusEl.textContent = "✅ Prepoznat tekst:\n" + text.slice(0, 400);

      const lines = text.split(/\n+/).map(l => l.trim()).filter(l => l.length);
      const title = lines[0] || "";
      const author = lines.find(l => /[A-ZČĆŽŠĐ][a-zčćžšđ]+\s+[A-ZČĆŽŠĐ][a-zčćžšđ]+/.test(l)) || "";
      const yearMatch = text.match(/(19|20)\d{2}/);
      const year = yearMatch ? yearMatch[0] : "";
      const publisher = lines.find(l => /(Laguna|Klett|Vulkan|Prosveta|Zavod|Nolit|Beograd)/i.test(l)) || "";

      document.getElementById('naslov').value ||= title;
      document.getElementById('autor').value ||= author;
      document.getElementById('godina').value ||= year;
      document.getElementById('izdavac').value ||= publisher;

    } catch (err) {
      console.error(err);
      statusEl.textContent = "❌ Greška pri prepoznavanju.";
    }
  };
  reader.readAsDataURL(lastFile);
});
</script>
</body>
</html>
