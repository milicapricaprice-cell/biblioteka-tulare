    try {
      const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${OCR_API_KEY}`, {
        method: "POST",
        body: JSON.stringify(body)
      });
      const data = await res.json();
      const text = data.responses?.[0]?.fullTextAnnotation?.text || "";

      if (!text) {
        statusEl.textContent = "⚠️ Nije pronađen tekst na slici.";
        return;
      }

      statusEl.textContent = "✅ Prepoznat tekst:\n" + text.slice(0, 500);
      const lines = text.split(/\n+/).map(l => l.trim()).filter(l => l.length > 1);

      const title = lines[0] || "";
      const year = (text.match(/(19|20)\d{2}/) || [""])[0];
      let author = lines.find(l => /\b[A-ZŠĐČĆŽ]/i.test(l) && l.split(' ').length <= 3) || "";
      let publisher = lines.find(l => /(Laguna|Klett|Vulkan|Prosveta|Zavod|Nolit|Beograd)/i.test(l)) || "";

      document.getElementById('naslov').value ||= title;
      document.getElementById('autor').value ||= author;
      document.getElementById('izdavac').value ||= publisher;
      document.getElementById('godina').value ||= year;

    } catch (err) {
      statusEl.textContent = "❌ Greška pri prepoznavanju.";
      console.error(err);
    }
  };
  reader.readAsDataURL(lastFile);
});
</script>
</body>
</html>
